
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Time Guardian: Lila's Quest</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: #87CEEB;
            color: #fff;
            overflow: hidden;
            font-size: 8px;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
            z-index: 100;
            text-align: center;
        }

        .game-title {
            font-size: 16px;
            color: #FFD700;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 2px;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            cursor: none;
            background: #87CEEB;
        }

        .ui-overlay {
            position: absolute;
            top: 60px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
            pointer-events: none;
        }

        .ui-panel {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #FFD700;
            border-radius: 5px;
            padding: 10px;
            pointer-events: auto;
        }

        .score {
            color: #FFD700;
            margin-bottom: 5px;
        }

        .lives {
            display: flex;
            gap: 5px;
        }

        .heart {
            width: 16px;
            height: 16px;
            background: #ff0066;
            display: inline-block;
            position: relative;
            transform: rotate(-45deg);
            margin: 0 3px;
        }

        .heart:before,
        .heart:after {
            content: '';
            width: 16px;
            height: 16px;
            position: absolute;
            background: #ff0066;
            border-radius: 50%;
        }

        .heart:before {
            top: -8px;
            left: 0;
        }

        .heart:after {
            left: 8px;
            top: 0;
        }

        .heart.empty {
            opacity: 0.3;
        }

        .menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #87CEEB, #98D8E8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .menu-screen.active {
            display: flex;
        }

        .menu-content {
            background: rgba(255, 255, 255, 0.9);
            border: 4px solid #8B4513;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 600px;
            color: #333;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .menu-content h2 {
            font-size: 20px;
            color: #FF6B6B;
            margin-bottom: 20px;
            text-shadow: 1px 1px 0 #000;
        }

        .menu-content p {
            font-size: 10px;
            line-height: 2;
            margin-bottom: 20px;
            color: #333;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 8px;
            font-size: 10px;
            background: #FF6B6B;
            border: 3px solid #8B4513;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            text-shadow: 1px 1px 0 #000;
            transition: transform 0.1s;
        }

        .btn:hover {
            transform: scale(1.05);
            background: #FF8787;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: #4ECDC4;
        }

        .btn-secondary:hover {
            background: #6ED9D1;
        }

        .mission-briefing {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #8B4513;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            display: none;
            z-index: 150;
            color: #333;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
        }

        .mission-briefing.active {
            display: block;
        }

        .stone-exercise {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #FFD700;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            display: none;
            z-index: 150;
            color: #333;
        }

        .stone-exercise.active {
            display: block;
        }

        .stone-exercise h3 {
            color: #FF6B6B;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .text-input {
            padding: 8px 12px;
            background: #f0f0f0;
            border: 2px solid #8B4513;
            border-radius: 5px;
            color: #333;
            font-size: 10px;
            width: 160px;
            margin: 0 5px;
            font-family: 'Press Start 2P', monospace;
        }

        .feedback {
            padding: 10px;
            margin-top: 10px;
            text-align: center;
            font-size: 10px;
            border-radius: 8px;
        }

        .feedback.success {
            background: #90EE90;
            border: 2px solid #228B22;
            color: #228B22;
        }

        .feedback.error {
            background: #FFB6C1;
            border: 2px solid #DC143C;
            color: #DC143C;
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #87CEEB;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }

        .loading-text {
            color: #333;
            font-size: 12px;
            margin-top: 20px;
        }

        /* Cutscene Styles */
        .cutscene-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 500;
            display: none;
            cursor: pointer;
        }

        .cutscene-container.active {
            display: block;
        }

        .panel {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .panel.active {
            opacity: 1;
        }

        /* Panel 1: Observatory */
        .panel1 {
            background: linear-gradient(to bottom, #0a0a2a 0%, #1a1a3a 50%, #2a2a4a 100%);
        }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(2px 2px at 20px 30px, #eee, transparent),
                radial-gradient(2px 2px at 40px 70px, #ddd, transparent),
                radial-gradient(1px 1px at 50px 160px, #fff, transparent),
                radial-gradient(1px 1px at 130px 40px, #fff, transparent),
                radial-gradient(2px 2px at 80px 10px, #eee, transparent);
            background-size: 800px 300px;
            animation: moveStars 100s linear infinite;
        }

        @keyframes moveStars {
            from { transform: translateX(0); }
            to { transform: translateX(-800px); }
        }

        .quinn-silhouette {
            position: absolute;
            bottom: 20%;
            left: 25%;
            width: 80px;
            height: 120px;
            background-color: #000;
        }

        .time-map {
            position: absolute;
            bottom: 25%;
            left: 40%;
            width: 200px;
            height: 150px;
            background: radial-gradient(ellipse at center, #4a7 30%, #295 60%, transparent 100%);
            opacity: 0.8;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { opacity: 0.6; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Panel 2: Watch Close-up */
        .panel2 {
            background: linear-gradient(to bottom, #1a1a2a 0%, #2a2a3a 100%);
        }

        .watch {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background-color: #d4af37;
            border-radius: 50%;
            border: 8px solid #b8941f;
            box-shadow: 0 0 40px #d4af37;
            animation: watchGlow 3s ease-in-out infinite;
        }

        .watch::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background-color: #f5e6d3;
            border-radius: 50%;
        }

        @keyframes watchGlow {
            0%, 100% { box-shadow: 0 0 40px #d4af37; }
            50% { box-shadow: 0 0 60px #d4af37, 0 0 100px #d4af3750; }
        }

        .timeline-fracture {
            position: absolute;
            top: 20%;
            left: 10%;
            right: 10%;
            height: 60%;
            overflow: hidden;
            opacity: 0.3;
        }

        .fracture-line {
            position: absolute;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, transparent, #f00, transparent);
            animation: fracture 4s ease-in-out infinite;
        }

        @keyframes fracture {
            0%, 100% { transform: scaleY(0); opacity: 0; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        /* Panel 3: Bookstore Attic */
        .panel3 {
            background: linear-gradient(to bottom, #3a2a1a 0%, #4a3a2a 100%);
        }

        .bookshelf {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 400px;
            background-color: #654321;
        }

        .lila-sprite {
            position: absolute;
            bottom: 30%;
            left: 45%;
            width: 60px;
            height: 80px;
            background-color: #4a90e2;
        }

        .glowing-box {
            position: absolute;
            bottom: 35%;
            left: 52%;
            width: 80px;
            height: 60px;
            background-color: #8b4513;
            border: 4px solid #654321;
            box-shadow: 0 0 20px #d4af37;
        }

        /* Panel 4: Time Glitch */
        .panel4 {
            background: linear-gradient(45deg, #1a1a1a 0%, #2a1a1a 50%, #1a2a1a 100%);
        }

        .glitch-container {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 300px;
        }

        .photo-frame {
            position: absolute;
            width: 120px;
            height: 150px;
            background-color: #8b7355;
            border: 8px solid #654321;
        }

        .disappearing-person {
            position: absolute;
            top: 20%;
            left: 30%;
            width: 40%;
            height: 60%;
            background-color: #333;
            opacity: 1;
            animation: vanish 4s ease-in-out infinite;
        }

        @keyframes vanish {
            0%, 30% { opacity: 1; }
            70%, 100% { opacity: 0; }
        }

        /* Panel 5: Philadelphia Street */
        .panel5 {
            background: linear-gradient(to bottom, #87ceeb 0%, #98d8f0 50%, #b8b8a0 50%, #a8a890 100%);
        }

        .colonial-building-cutscene {
            position: absolute;
            bottom: 0;
            width: 200px;
            height: 300px;
            background-color: #8b4513;
        }

        .cobblestone {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100px;
            background-color: #696969;
        }

        .lila-ready {
            position: absolute;
            bottom: 15%;
            left: 10%;
            width: 40px;
            height: 60px;
            background-color: #4a90e2;
        }

        .time-stone-cutscene {
            position: absolute;
            bottom: 18%;
            right: 20%;
            width: 30px;
            height: 30px;
            background-color: #e74c3c;
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                box-shadow: 0 0 10px #e74c3c;
            }
            50% {
                transform: scale(1.1) rotate(180deg);
                box-shadow: 0 0 20px #e74c3c;
            }
        }

        .cutscene-textbox {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background-color: #1a1a1a;
            border: 4px solid #fff;
            padding: 20px;
            color: #fff;
            font-size: 10px;
            line-height: 1.8;
            min-height: 80px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        .speaker-name {
            color: #4a90e2;
            margin-bottom: 10px;
            display: block;
        }

        .continue-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #fff;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .skip-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: #fff;
            border: 2px solid #fff;
            padding: 8px 16px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }

        .skip-button:hover {
            background-color: #555;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="game-header">
            <h1 class="game-title" id="gameTitle">THE TIME GUARDIAN</h1>
            <div id="levelSubtitle" style="font-size: 12px; color: #FFD700; margin-top: 5px; display: none;"></div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div class="ui-overlay">
            <div class="ui-panel">
                <div class="score">SCORE: <span id="scoreDisplay">0</span></div>
                <div class="time-stones">TIME STONES: <span id="stoneCount">0</span></div>
            </div>
            <div class="ui-panel">
                <div class="lives" id="livesDisplay">
                    <div class="heart"></div>
                    <div class="heart"></div>
                    <div class="heart"></div>
                </div>
            </div>
        </div>

        <div id="mainMenu" class="menu-screen active">
            <div class="menu-content">
                <h2>THE TIME GUARDIAN</h2>
                <p>SAVE TIME ITSELF FROM DR. CHRONOS!<br><br>
                   YOU ARE LILA TORRES,<br>
                   GUARDIAN OF TIME.</p>
                <button class="btn" id="beginBtn">BEGIN MISSION</button>
                <button class="btn btn-secondary" id="levelBtn">LEVEL SELECT</button>
            </div>
        </div>

        <div id="missionBriefing" class="mission-briefing">
            <p><strong>PROFESSOR QUINN:</strong><br><br>
               "THE WATCH CHOSE YOU, LILA.<br>
               COLLECT THE TIME STONES<br>
               AND STOP CHRONOS!"</p>
            <button class="btn" id="startBtn">START GAME</button>
        </div>

        <div id="levelSelect" class="menu-screen">
            <div class="menu-content">
                <h2>SELECT LEVEL</h2>
                <button class="btn" id="level1Btn">LEVEL 1: 1776</button>
                <button class="btn" id="level2Btn">LEVEL 2: 1865</button>
                <button class="btn" id="level3Btn">LEVEL 3: 1963</button>
                <button class="btn btn-secondary" id="backBtn">BACK</button>
            </div>
        </div>

        <div id="levelComplete" class="menu-screen">
            <div class="menu-content">
                <h2>LEVEL COMPLETE!</h2>
                <p>SCORE: <span id="levelScore">0</span></p>
                <button class="btn" id="nextBtn">NEXT LEVEL</button>
                <button class="btn btn-secondary" id="menuBtn">MAIN MENU</button>
            </div>
        </div>

        <div id="gameOver" class="menu-screen">
            <div class="menu-content">
                <h2 style="color: #DC143C;">GAME OVER</h2>
                <p>CHRONOS HAS WON...<br>
                   TRY AGAIN?</p>
                <button class="btn" id="retryBtn">RETRY</button>
                <button class="btn btn-secondary" id="menuBtn2">MAIN MENU</button>
            </div>
        </div>

        <div id="stoneExercise" class="stone-exercise">
            <h3>TIME STONE CHALLENGE</h3>
            <div id="stoneExerciseContent"></div>
            <div id="stoneExerciseFeedback"></div>
            <div style="margin-top: 15px; text-align: center;">
                <button class="btn" id="submitBtn">SUBMIT</button>
            </div>
        </div>

        <div id="loadingScreen" class="loading-screen">
            <div class="loading-text">LOADING...</div>
        </div>

        <!-- Cutscene Container -->
        <div class="cutscene-container" id="cutsceneContainer">
            <!-- Panel 1: Observatory -->
            <div class="panel panel1 active" id="panel1">
                <div class="stars"></div>
                <div class="quinn-silhouette"></div>
                <div class="time-map"></div>
                <div class="cutscene-textbox">
                    <span class="speaker-name">Professor Quinn:</span>
                    "So... the Watch chose you. I didn't expect someone so young... but time rarely does what we expect."
                    <div class="continue-indicator"></div>
                </div>
            </div>

            <!-- Panel 2: Watch Close-up -->
            <div class="panel panel2" id="panel2">
                <div class="timeline-fracture">
                    <div class="fracture-line" style="left: 20%;"></div>
                    <div class="fracture-line" style="left: 40%; animation-delay: 0.5s;"></div>
                    <div class="fracture-line" style="left: 60%; animation-delay: 1s;"></div>
                    <div class="fracture-line" style="left: 80%; animation-delay: 1.5s;"></div>
                </div>
                <div class="watch"></div>
                <div class="cutscene-textbox">
                    <span class="speaker-name">Professor Quinn:</span>
                    "Time is breaking. My old friend Elias Morgenstern... he's become Chronos. Grief twisted him. He's begun to erase history, thread by thread."
                    <div class="continue-indicator"></div>
                </div>
            </div>

            <!-- Panel 3: Bookstore Attic -->
            <div class="panel panel3" id="panel3">
                <div class="bookshelf"></div>
                <div class="lila-sprite"></div>
                <div class="glowing-box"></div>
                <div class="cutscene-textbox">
                    <span class="speaker-name">Narrator:</span>
                    "Lila Torres never thought she was special. But the moment she touched the watch, the world... shifted."
                    <div class="continue-indicator"></div>
                </div>
            </div>

            <!-- Panel 4: Time Glitch -->
            <div class="panel panel4" id="panel4">
                <div class="glitch-container">
                    <div class="photo-frame" style="top: 20px; left: 50px;">
                        <div class="disappearing-person"></div>
                    </div>
                    <div class="photo-frame" style="top: 40px; right: 80px;">
                        <div class="disappearing-person" style="animation-delay: 0.5s;"></div>
                    </div>
                    <div class="photo-frame" style="bottom: 20px; left: 200px;">
                        <div class="disappearing-person" style="animation-delay: 1s;"></div>
                    </div>
                </div>
                <div class="cutscene-textbox">
                    <span class="speaker-name">Professor Quinn:</span>
                    "If we don't act now, time itself will unravel. That's why you must go back to where Elias first lost hope..."
                    <div class="continue-indicator"></div>
                </div>
            </div>

            <!-- Panel 5: Philadelphia Street -->
            <div class="panel panel5" id="panel5">
                <div class="colonial-building-cutscene" style="left: 0; height: 280px;"></div>
                <div class="colonial-building-cutscene" style="left: 200px;"></div>
                <div class="colonial-building-cutscene" style="left: 400px; height: 320px;"></div>
                <div class="colonial-building-cutscene" style="right: 0; height: 290px;"></div>
                <div class="cobblestone"></div>
                <div class="lila-ready"></div>
                <div class="time-stone-cutscene"></div>
                <div class="cutscene-textbox">
                    <span class="speaker-name">Professor Quinn:</span>
                    "Philadelphia, 1776. This was when Elias still believed in change. Help him remember... If they unite, they will gain their freedom."
                    <div class="continue-indicator"></div>
                </div>
            </div>

            <button class="skip-button" id="skipBtn">SKIP</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = true; // Enable smoothing for 32-bit style

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Game state
        const game = {
            state: 'menu',
            currentLevel: 1,
            score: 0,
            lives: 3,
            camera: { x: 0, y: 0 },
            stonesCollected: 0,
            levelData: null,
            currentStoneExercise: null,
            cutsceneShown: false
        };

        // Cutscene variables
        let currentPanel = 1;
        const totalPanels = 5;
        let isTransitioning = false;

        // Player
        const player = {
            x: 50,
            y: 450,
            width: 32,
            height: 48,
            vx: 0,
            vy: 0,
            speed: 4,
            jumpPower: 12,
            grounded: false,
            facing: 'right',
            animFrame: 0,
            animTimer: 0
        };

        // Physics
        const GRAVITY = 0.5;
        const FRICTION = 0.85;

        // Input
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;

            // Handle different game states
            if (game.state === 'cutscene') {
                if (e.key === ' ' || e.key === 'Enter') {
                    e.preventDefault();
                    nextPanel();
                } else if (e.key === 'Escape') {
                    skipCutscene();
                }
            } else if (e.key === 'Enter' && game.state === 'exercise') {
                checkStoneAnswer();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Button event listeners
        document.getElementById('beginBtn').addEventListener('click', showMissionBriefing);
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('levelBtn').addEventListener('click', showLevelSelect);
        document.getElementById('backBtn').addEventListener('click', showMainMenu);
        document.getElementById('menuBtn').addEventListener('click', showMainMenu);
        document.getElementById('menuBtn2').addEventListener('click', showMainMenu);
        document.getElementById('retryBtn').addEventListener('click', retryLevel);
        document.getElementById('nextBtn').addEventListener('click', nextLevel);
        document.getElementById('submitBtn').addEventListener('click', checkStoneAnswer);
        document.getElementById('skipBtn').addEventListener('click', skipCutscene);

        // Level buttons
        document.getElementById('level1Btn').addEventListener('click', () => selectLevel(1));
        document.getElementById('level2Btn').addEventListener('click', () => selectLevel(2));
        document.getElementById('level3Btn').addEventListener('click', () => selectLevel(3));

        // Cutscene click handler
        document.getElementById('cutsceneContainer').addEventListener('click', function(e) {
            if (e.target.id !== 'skipBtn' && !e.target.classList.contains('skip-button')) {
                nextPanel();
            }
        });

        // Levels
        const levels = {
            1: {
                title: "PHILADELPHIA, 1776",
                platforms: [
                    // Ground level platforms
                    { x: 0, y: 520, width: 250, height: 80 },
                    { x: 350, y: 520, width: 200, height: 80 },
                    { x: 650, y: 520, width: 150, height: 80 },
                    { x: 900, y: 520, width: 200, height: 80 },
                    { x: 1200, y: 520, width: 300, height: 80 },
                    { x: 1600, y: 520, width: 250, height: 80 },
                    { x: 1950, y: 520, width: 300, height: 80 },

                    // Mid-level floating platforms
                    { x: 400, y: 400, width: 100, height: 20 },
                    { x: 700, y: 350, width: 120, height: 20 },
                    { x: 1000, y: 300, width: 100, height: 20 },
                    { x: 1300, y: 400, width: 150, height: 20 },
                    { x: 1550, y: 450, width: 100, height: 20 },
                    { x: 1700, y: 350, width: 100, height: 20 },

                    // Upper level platforms
                    { x: 550, y: 250, width: 100, height: 20 },
                    { x: 850, y: 200, width: 120, height: 20 },
                    { x: 1150, y: 250, width: 100, height: 20 },
                    { x: 1450, y: 200, width: 120, height: 20 }
                ],
                timeHoles: [
                    { x: 250, y: 520, width: 100, height: 80 },
                    { x: 550, y: 520, width: 100, height: 80 },
                    { x: 800, y: 520, width: 100, height: 80 },
                    { x: 1100, y: 520, width: 100, height: 80 },
                    { x: 1500, y: 520, width: 100, height: 80 },
                    { x: 1850, y: 520, width: 100, height: 80 }
                ],
                stones: [
                    { x: 450, y: 360, collected: false, id: 0 },
                    { x: 600, y: 210, collected: false, id: 1 },
                    { x: 1050, y: 260, collected: false, id: 2 },
                    { x: 1375, y: 360, collected: false, id: 3 },
                    { x: 1750, y: 310, collected: false, id: 4 }
                ],
                enemies: [
                    { x: 700, y: 326, width: 32, height: 32, vx: 1, range: 80 },
                    { x: 850, y: 176, width: 32, height: 32, vx: -1, range: 80 },
                    { x: 1200, y: 488, width: 32, height: 32, vx: 1, range: 200 },
                    { x: 1450, y: 176, width: 32, height: 32, vx: 1, range: 80 }
                ],
                portal: { x: 2100, y: 450, width: 60, height: 70 },
                background: {
                    colonialBuildings: [
                        { x: 200, y: 440 },
                        { x: 800, y: 440 },
                        { x: 1400, y: 440 },
                        { x: 1900, y: 440 }
                    ],
                    libertyBell: { x: 1100, y: 420 },
                    streetLamps: [
                        { x: 100, y: 470 },
                        { x: 600, y: 470 },
                        { x: 1300, y: 470 },
                        { x: 1800, y: 470 }
                    ],
                    horses: [
                        { x: 450, y: 470 },
                        { x: 1000, y: 470 }
                    ]
                },
                exercises: [
                    {
                        question: "If the colonies _____ (unite), they will gain freedom.",
                        answer: "unite",
                        hint: "First conditional: present simple"
                    },
                    {
                        question: "If people _____ (believe) in liberty, they will fight.",
                        answer: "believe",
                        hint: "Present simple"
                    },
                    {
                        question: "If the Declaration _____ (be) signed, history will change.",
                        answer: "is",
                        hint: "Use 'is' for singular"
                    },
                    {
                        question: "If citizens _____ (stand) together, they will succeed.",
                        answer: "stand",
                        hint: "Present simple"
                    },
                    {
                        question: "If leaders _____ (speak) truth, people will follow.",
                        answer: "speak",
                        hint: "Present simple"
                    }
                ]
            },
            2: {
                title: "1865 - Civil War",
                platforms: [
                    { x: 0, y: 500, width: 300, height: 100 },
                    { x: 400, y: 550, width: 150, height: 50 },
                    { x: 650, y: 450, width: 250, height: 150 },
                    { x: 1000, y: 400, width: 200, height: 200 },
                    { x: 1300, y: 350, width: 300, height: 250 },
                    { x: 1700, y: 500, width: 400, height: 100 }
                ],
                stones: [
                    { x: 475, y: 500, collected: false, id: 0 },
                    { x: 775, y: 400, collected: false, id: 1 },
                    { x: 1100, y: 350, collected: false, id: 2 },
                    { x: 1450, y: 300, collected: false, id: 3 }
                ],
                enemies: [
                    { x: 1200, y: 370, width: 32, height: 32, vx: -1, range: 80 },
                    { x: 800, y: 420, width: 32, height: 32, vx: 1, range: 100 }
                ],
                portal: { x: 1900, y: 430, width: 60, height: 70 },
                background: {
                    trees: [{ x: 200, y: 400 }, { x: 1100, y: 300 }],
                    windmill: { x: 1500, y: 150 }
                },
                exercises: [
                    {
                        question: "If the war _____ (end), families would reunite.",
                        answer: "ended",
                        hint: "Past simple"
                    },
                    {
                        question: "If people _____ (have) peace, they'd be happy.",
                        answer: "had",
                        hint: "Past simple"
                    },
                    {
                        question: "If unity _____ (be) possible, hope would grow.",
                        answer: "were",
                        hint: "Use 'were'"
                    },
                    {
                        question: "If we _____ (work) together, we'd heal.",
                        answer: "worked",
                        hint: "Past simple"
                    }
                ]
            },
            3: {
                title: "1963 - Civil Rights",
                platforms: [
                    { x: 0, y: 550, width: 350, height: 50 },
                    { x: 450, y: 500, width: 200, height: 100 },
                    { x: 750, y: 450, width: 250, height: 150 },
                    { x: 1100, y: 400, width: 300, height: 200 },
                    { x: 1500, y: 350, width: 200, height: 250 },
                    { x: 1800, y: 500, width: 400, height: 100 }
                ],
                stones: [
                    { x: 550, y: 450, collected: false, id: 0 },
                    { x: 875, y: 400, collected: false, id: 1 },
                    { x: 1250, y: 350, collected: false, id: 2 },
                    { x: 1600, y: 300, collected: false, id: 3 }
                ],
                enemies: [
                    { x: 900, y: 420, width: 32, height: 32, vx: -1, range: 100 }
                ],
                portal: { x: 2000, y: 430, width: 60, height: 70 },
                background: {
                    trees: [{ x: 350, y: 450 }, { x: 1200, y: 350 }, { x: 1700, y: 400 }],
                    windmill: { x: 800, y: 250 }
                },
                exercises: [
                    {
                        question: "If we _____ (march), change will come.",
                        answer: "march",
                        hint: "Present simple"
                    },
                    {
                        question: "If laws _____ (be) fair, we wouldn't protest.",
                        answer: "were",
                        hint: "Use 'were'"
                    },
                    {
                        question: "If people _____ (unite), justice would win.",
                        answer: "united",
                        hint: "Past simple"
                    },
                    {
                        question: "If you _____ (join) us, history changes.",
                        answer: "join",
                        hint: "Present simple"
                    }
                ]
            }
        };

        // Draw character (Lila with lilac hair and pink clothes - 32-bit style)
        function drawLila(x, y, facing) {
            ctx.save();
            ctx.translate(x, y);

            if (facing === 'left') {
                ctx.scale(-1, 1);
                ctx.translate(-32, 0);
            }

            // Hair (lilac) - more detailed
            const gradient = ctx.createLinearGradient(0, 0, 0, 20);
            gradient.addColorStop(0, '#E6B8EA');
            gradient.addColorStop(1, '#DDA0DD');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.ellipse(16, 10, 14, 16, 0, 0, Math.PI * 2);
            ctx.fill();

            // Hair strands
            ctx.strokeStyle = '#C890CC';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(8, 5);
            ctx.quadraticCurveTo(12, 15, 10, 20);
            ctx.moveTo(24, 5);
            ctx.quadraticCurveTo(20, 15, 22, 20);
            ctx.stroke();

            // Face (peach) with shading
            const faceGradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 8);
            faceGradient.addColorStop(0, '#FFD4C4');
            faceGradient.addColorStop(1, '#FDBCB4');
            ctx.fillStyle = faceGradient;
            ctx.beginPath();
            ctx.ellipse(16, 16, 8, 10, 0, 0, Math.PI * 2);
            ctx.fill();

            // Eyes (detailed)
            ctx.fillStyle = '#fff';
            ctx.fillRect(11, 14, 4, 4);
            ctx.fillRect(17, 14, 4, 4);
            ctx.fillStyle = '#4A90E2';
            ctx.fillRect(12, 15, 2, 2);
            ctx.fillRect(18, 15, 2, 2);
            ctx.fillStyle = '#000';
            ctx.fillRect(12.5, 15.5, 1, 1);
            ctx.fillRect(18.5, 15.5, 1, 1);

            // Mouth
            ctx.strokeStyle = '#D68B8B';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(16, 20, 2, 0, Math.PI);
            ctx.stroke();

            // Shirt (pink) with shading
            const shirtGradient = ctx.createLinearGradient(0, 26, 0, 36);
            shirtGradient.addColorStop(0, '#FF69B4');
            shirtGradient.addColorStop(1, '#FF1493');
            ctx.fillStyle = shirtGradient;
            ctx.fillRect(8, 26, 16, 12);
            ctx.fillRect(4, 28, 24, 8);

            // Arms with shading
            ctx.fillStyle = '#FDBCB4';
            ctx.fillRect(2, 28, 6, 10);
            ctx.fillRect(24, 28, 6, 10);
            ctx.fillStyle = '#FFB5A5';
            ctx.fillRect(2, 35, 6, 3);
            ctx.fillRect(24, 35, 6, 3);

            // Pants (dark blue)
            const pantsGradient = ctx.createLinearGradient(0, 38, 0, 48);
            pantsGradient.addColorStop(0, '#2C3E50');
            pantsGradient.addColorStop(1, '#1A252F');
            ctx.fillStyle = pantsGradient;
            ctx.fillRect(10, 38, 12, 10);

            // Shoes (black with highlight)
            ctx.fillStyle = '#000';
            ctx.fillRect(10, 46, 5, 2);
            ctx.fillRect(17, 46, 5, 2);
            ctx.fillStyle = '#333';
            ctx.fillRect(10, 46, 5, 1);
            ctx.fillRect(17, 46, 5, 1);

            ctx.restore();
        }

        // Draw colonial building (32-bit style)
        function drawColonialBuilding(x, y) {
            // Shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(x - 45, y + 55, 90, 10);

            // Main building with gradient
            const wallGradient = ctx.createLinearGradient(x - 40, y, x + 40, y);
            wallGradient.addColorStop(0, '#D2691E');
            wallGradient.addColorStop(0.5, '#CD853F');
            wallGradient.addColorStop(1, '#BC7F3F');
            ctx.fillStyle = wallGradient;
            ctx.fillRect(x - 40, y, 80, 60);

            // Brick texture
            ctx.strokeStyle = '#A0522D';
            ctx.lineWidth = 0.5;
            for (let by = y; by < y + 60; by += 8) {
                for (let bx = x - 40; bx < x + 40; bx += 15) {
                    ctx.strokeRect(bx, by, 15, 8);
                }
            }

            // Roof with shading
            const roofGradient = ctx.createLinearGradient(x, y - 30, x, y);
            roofGradient.addColorStop(0, '#8B4513');
            roofGradient.addColorStop(1, '#654321');
            ctx.fillStyle = roofGradient;
            ctx.beginPath();
            ctx.moveTo(x - 50, y);
            ctx.lineTo(x, y - 30);
            ctx.lineTo(x + 50, y);
            ctx.closePath();
            ctx.fill();

            // Windows with shutters
            for (let wx = -30; wx <= 15; wx += 22) {
                // Window
                ctx.fillStyle = '#4682B4';
                ctx.fillRect(x + wx, y + 10, 15, 20);

                // Window panes
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.strokeRect(x + wx, y + 10, 15, 20);
                ctx.beginPath();
                ctx.moveTo(x + wx + 7.5, y + 10);
                ctx.lineTo(x + wx + 7.5, y + 30);
                ctx.moveTo(x + wx, y + 20);
                ctx.lineTo(x + wx + 15, y + 20);
                ctx.stroke();

                // Shutters
                ctx.fillStyle = '#2F4F4F';
                ctx.fillRect(x + wx - 3, y + 10, 3, 20);
                ctx.fillRect(x + wx + 15, y + 10, 3, 20);
            }

            // Door with detail
            const doorGradient = ctx.createLinearGradient(x - 8, y + 35, x + 8, y + 35);
            doorGradient.addColorStop(0, '#654321');
            doorGradient.addColorStop(0.5, '#8B4513');
            doorGradient.addColorStop(1, '#654321');
            ctx.fillStyle = doorGradient;
            ctx.fillRect(x - 8, y + 35, 16, 25);

            // Door panels
            ctx.strokeStyle = '#4A3018';
            ctx.lineWidth = 1;
            ctx.strokeRect(x - 6, y + 37, 5, 8);
            ctx.strokeRect(x + 1, y + 37, 5, 8);
            ctx.strokeRect(x - 6, y + 47, 5, 10);
            ctx.strokeRect(x + 1, y + 47, 5, 10);

            // Doorknob
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(x + 5, y + 48, 1.5, 0, Math.PI * 2);
            ctx.fill();

            // Chimney
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x + 25, y - 25, 10, 20);

            // Smoke
            ctx.fillStyle = 'rgba(128, 128, 128, 0.3)';
            const time = Date.now() / 1000;
            for (let i = 0; i < 3; i++) {
                const sy = y - 30 - i * 15 - (time * 10) % 30;
                const sx = x + 30 + Math.sin(time + i) * 5;
                ctx.beginPath();
                ctx.arc(sx, sy, 5 + i * 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Draw Liberty Bell (32-bit style)
        function drawLibertyBell(x, y) {
            // Support structure with gradient
            const supportGradient = ctx.createLinearGradient(x - 30, y - 30, x + 30, y - 30);
            supportGradient.addColorStop(0, '#654321');
            supportGradient.addColorStop(0.5, '#8B4513');
            supportGradient.addColorStop(1, '#654321');
            ctx.fillStyle = supportGradient;
            ctx.fillRect(x - 30, y - 20, 60, 10);
            ctx.fillRect(x - 25, y - 30, 10, 30);
            ctx.fillRect(x + 15, y - 30, 10, 30);

            // Bell shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.ellipse(x + 2, y + 52, 22, 8, 0, 0, Math.PI * 2);
            ctx.fill();

            // Bell with gradient
            const bellGradient = ctx.createRadialGradient(x - 10, y + 10, 0, x, y + 20, 25);
            bellGradient.addColorStop(0, '#FFD700');
            bellGradient.addColorStop(0.5, '#CD7F32');
            bellGradient.addColorStop(1, '#B87333');
            ctx.fillStyle = bellGradient;

            // Bell shape
            ctx.beginPath();
            ctx.moveTo(x - 15, y);
            ctx.quadraticCurveTo(x - 20, y + 20, x - 18, y + 40);
            ctx.lineTo(x - 16, y + 50);
            ctx.lineTo(x + 16, y + 50);
            ctx.lineTo(x + 18, y + 40);
            ctx.quadraticCurveTo(x + 20, y + 20, x + 15, y);
            ctx.closePath();
            ctx.fill();

            // Bell top
            ctx.beginPath();
            ctx.arc(x, y, 15, Math.PI, 0, false);
            ctx.fill();

            // Crack with detail
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y + 5);
            ctx.lineTo(x + 3, y + 25);
            ctx.lineTo(x - 2, y + 45);
            ctx.stroke();

            // Crack shadow
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x + 1, y + 5);
            ctx.lineTo(x + 4, y + 25);
            ctx.lineTo(x - 1, y + 45);
            ctx.stroke();

            // Clapper
            const clapperGradient = ctx.createLinearGradient(x - 2, y + 40, x + 2, y + 40);
            clapperGradient.addColorStop(0, '#333');
            clapperGradient.addColorStop(0.5, '#666');
            clapperGradient.addColorStop(1, '#333');
            ctx.fillStyle = clapperGradient;
            ctx.fillRect(x - 2, y + 40, 4, 10);
            ctx.beginPath();
            ctx.arc(x, y + 52, 4, 0, Math.PI * 2);
            ctx.fill();

            // Inscription
            ctx.fillStyle = '#8B4513';
            ctx.font = '4px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('1776', x, y + 25);
            ctx.textAlign = 'left';
        }

        // Draw street lamp (32-bit style)
        function drawStreetLamp(x, y) {
            // Lamp post with gradient
            const postGradient = ctx.createLinearGradient(x - 3, y, x + 3, y);
            postGradient.addColorStop(0, '#2F4F4F');
            postGradient.addColorStop(0.5, '#696969');
            postGradient.addColorStop(1, '#2F4F4F');
            ctx.fillStyle = postGradient;
            ctx.fillRect(x - 3, y - 40, 6, 40);

            // Lamp top
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.moveTo(x - 10, y - 40);
            ctx.lineTo(x - 15, y - 50);
            ctx.lineTo(x + 15, y - 50);
            ctx.lineTo(x + 10, y - 40);
            ctx.closePath();
            ctx.fill();

            // Glass panels
            const glassGradient = ctx.createLinearGradient(x - 10, y - 65, x + 10, y - 65);
            glassGradient.addColorStop(0, 'rgba(255, 255, 224, 0.6)');
            glassGradient.addColorStop(0.5, 'rgba(255, 255, 200, 0.8)');
            glassGradient.addColorStop(1, 'rgba(255, 255, 224, 0.6)');
            ctx.fillStyle = glassGradient;
            ctx.fillRect(x - 10, y - 65, 20, 15);

            // Light glow
            const glowGradient = ctx.createRadialGradient(x, y - 57, 0, x, y - 57, 30);
            glowGradient.addColorStop(0, 'rgba(255, 255, 200, 0.4)');
            glowGradient.addColorStop(1, 'rgba(255, 255, 200, 0)');
            ctx.fillStyle = glowGradient;
            ctx.fillRect(x - 30, y - 87, 60, 60);

            // Lamp cap
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.moveTo(x - 12, y - 65);
            ctx.lineTo(x, y - 72);
            ctx.lineTo(x + 12, y - 65);
            ctx.closePath();
            ctx.fill();
        }

        // Draw horse and carriage (32-bit style)
        function drawHorseCarriage(x, y) {
            // Carriage wheels
            ctx.fillStyle = '#654321';
            ctx.beginPath();
            ctx.arc(x + 20, y + 20, 12, 0, Math.PI * 2);
            ctx.arc(x + 60, y + 20, 12, 0, Math.PI * 2);
            ctx.fill();

            // Wheel spokes
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 1;
            for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 4) {
                ctx.beginPath();
                ctx.moveTo(x + 20 + Math.cos(angle) * 3, y + 20 + Math.sin(angle) * 3);
                ctx.lineTo(x + 20 + Math.cos(angle) * 12, y + 20 + Math.sin(angle) * 12);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x + 60 + Math.cos(angle) * 3, y + 20 + Math.sin(angle) * 3);
                ctx.lineTo(x + 60 + Math.cos(angle) * 12, y + 20 + Math.sin(angle) * 12);
                ctx.stroke();
            }

            // Carriage body
            const carriageGradient = ctx.createLinearGradient(x + 10, y - 10, x + 10, y + 10);
            carriageGradient.addColorStop(0, '#8B0000');
            carriageGradient.addColorStop(1, '#4B0000');
            ctx.fillStyle = carriageGradient;
            ctx.fillRect(x + 10, y - 10, 60, 25);

            // Carriage window
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(x + 25, y - 5, 30, 12);
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 1;
            ctx.strokeRect(x + 25, y - 5, 30, 12);

            // Horse body
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.ellipse(x - 20, y, 25, 15, 0, 0, Math.PI * 2);
            ctx.fill();

            // Horse legs
            ctx.fillRect(x - 35, y + 10, 4, 20);
            ctx.fillRect(x - 25, y + 10, 4, 20);
            ctx.fillRect(x - 15, y + 10, 4, 20);
            ctx.fillRect(x - 5, y + 10, 4, 20);

            // Horse head
            ctx.beginPath();
            ctx.ellipse(x - 40, y - 5, 12, 8, -0.3, 0, Math.PI * 2);
            ctx.fill();

            // Horse mane
            ctx.fillStyle = '#654321';
            ctx.beginPath();
            ctx.moveTo(x - 30, y - 10);
            ctx.quadraticCurveTo(x - 25, y - 15, x - 20, y - 8);
            ctx.quadraticCurveTo(x - 22, y - 5, x - 25, y - 3);
            ctx.closePath();
            ctx.fill();

            // Reins
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x - 35, y - 5);
            ctx.lineTo(x + 10, y);
            ctx.stroke();
        }

        // Draw time stone (32-bit style)
        function drawStone(x, y) {
            const pulse = Math.sin(Date.now() / 300) * 0.3 + 0.7;

            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(Date.now() / 1000);

            // Outer glow
            const glowGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 20);
            glowGradient.addColorStop(0, `rgba(255, 215, 0, ${pulse})`);
            glowGradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
            ctx.fillStyle = glowGradient;
            ctx.fillRect(-25, -25, 50, 50);

            // Stone with gradient
            const stoneGradient = ctx.createRadialGradient(-3, -3, 0, 0, 0, 10);
            stoneGradient.addColorStop(0, '#FFD700');
            stoneGradient.addColorStop(0.5, '#FFA500');
            stoneGradient.addColorStop(1, '#FF8C00');
            ctx.fillStyle = stoneGradient;
            ctx.beginPath();
            ctx.moveTo(-8, 0);
            ctx.lineTo(0, -8);
            ctx.lineTo(8, 0);
            ctx.lineTo(0, 8);
            ctx.closePath();
            ctx.fill();

            // Inner light
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.beginPath();
            ctx.moveTo(-4, 0);
            ctx.lineTo(0, -4);
            ctx.lineTo(4, 0);
            ctx.lineTo(0, 4);
            ctx.closePath();
            ctx.fill();

            ctx.restore();
        }

        // Draw enemy (32-bit red guard)
        function drawEnemy(x, y) {
            // Shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.ellipse(x + 16, y + 32, 12, 4, 0, 0, Math.PI * 2);
            ctx.fill();

            // Body
            const bodyGradient = ctx.createLinearGradient(x, y, x, y + 32);
            bodyGradient.addColorStop(0, '#DC143C');
            bodyGradient.addColorStop(1, '#8B0000');
            ctx.fillStyle = bodyGradient;
            ctx.fillRect(x + 8, y + 12, 16, 20);

            // Head
            ctx.fillStyle = '#FDBCB4';
            ctx.beginPath();
            ctx.arc(x + 16, y + 8, 8, 0, Math.PI * 2);
            ctx.fill();

            // Hat
            ctx.fillStyle = '#8B0000';
            ctx.fillRect(x + 8, y, 16, 6);
            ctx.fillRect(x + 6, y + 5, 20, 3);

            // Eyes
            ctx.fillStyle = '#fff';
            ctx.fillRect(x + 11, y + 6, 3, 3);
            ctx.fillRect(x + 18, y + 6, 3, 3);
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 12, y + 7, 1, 1);
            ctx.fillRect(x + 19, y + 7, 1, 1);

            // Arms
            ctx.fillStyle = '#DC143C';
            ctx.fillRect(x + 4, y + 14, 4, 12);
            ctx.fillRect(x + 24, y + 14, 4, 12);

            // Musket
            ctx.fillStyle = '#654321';
            ctx.fillRect(x + 26, y + 8, 2, 20);
            ctx.fillStyle = '#C0C0C0';
            ctx.fillRect(x + 26, y + 8, 2, 5);
        }

        // Draw portal (32-bit style)
        function drawPortal(x, y, unlocked) {
            if (unlocked) {
                const time = Date.now() / 500;

                // Portal swirl effect
                for (let i = 0; i < 5; i++) {
                    const alpha = 1 - i * 0.2;
                    const scale = 1 + i * 0.3;

                    ctx.save();
                    ctx.translate(x + 30, y + 35);
                    ctx.rotate(time + i * 0.5);
                    ctx.scale(scale, scale);

                    const portalGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 30);
                    portalGradient.addColorStop(0, `rgba(147, 112, 219, ${alpha})`);
                    portalGradient.addColorStop(0.5, `rgba(138, 43, 226, ${alpha * 0.7})`);
                    portalGradient.addColorStop(1, `rgba(75, 0, 130, ${alpha * 0.3})`);

                    ctx.fillStyle = portalGradient;
                    ctx.beginPath();
                    ctx.ellipse(0, 0, 20, 30, 0, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.restore();
                }

                // Central bright spot
                const centerGradient = ctx.createRadialGradient(x + 30, y + 35, 0, x + 30, y + 35, 10);
                centerGradient.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
                centerGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                ctx.fillStyle = centerGradient;
                ctx.beginPath();
                ctx.ellipse(x + 30, y + 35, 10, 15, 0, 0, Math.PI * 2);
                ctx.fill();
            } else {
                // Locked portal frame
                const frameGradient = ctx.createLinearGradient(x, y, x + 60, y);
                frameGradient.addColorStop(0, '#333');
                frameGradient.addColorStop(0.5, '#666');
                frameGradient.addColorStop(1, '#333');
                ctx.fillStyle = frameGradient;
                ctx.fillRect(x, y, 60, 70);

                // Inner darkness
                ctx.fillStyle = '#000';
                ctx.fillRect(x + 5, y + 5, 50, 60);

                // Lock
                ctx.fillStyle = '#FFD700';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('🔒', x + 30, y + 40);
                ctx.textAlign = 'left';

                // Frame details
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 2;
                ctx.strokeRect(x + 2, y + 2, 56, 66);
            }
        }

        // Menu functions
        function showMainMenu() {
            game.state = 'menu';
            document.querySelectorAll('.menu-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('mainMenu').classList.add('active');
        }

        function showMissionBriefing() {
            document.getElementById('missionBriefing').classList.add('active');
        }

        function showLevelSelect() {
            document.querySelectorAll('.menu-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('levelSelect').classList.add('active');
        }

        function selectLevel(num) {
            game.currentLevel = num;
            game.score = 0;
            game.lives = 3;
            loadLevel(num);
            document.querySelectorAll('.menu-screen').forEach(s => s.classList.remove('active'));
            game.state = 'playing';
        }

        function startGame() {
            game.currentLevel = 1;
            game.score = 0;
            game.lives = 3;
            document.getElementById('missionBriefing').classList.remove('active');

            // Show cutscene for Level 1
            showFullCutscene();
        }

        // Cutscene functions
        function showFullCutscene() {
            game.state = 'cutscene';
            currentPanel = 1;
            document.getElementById('cutsceneContainer').classList.add('active');
            showPanel(1);
        }

        function showPanel(panelNumber) {
            if (isTransitioning) return;
            isTransitioning = true;

            // Hide all panels
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Show the current panel
            setTimeout(() => {
                document.getElementById(`panel${panelNumber}`).classList.add('active');
                isTransitioning = false;
            }, 500);
        }

        function nextPanel() {
            if (currentPanel < totalPanels) {
                currentPanel++;
                showPanel(currentPanel);
            } else {
                endCutscene();
            }
        }

        function skipCutscene() {
            endCutscene();
        }

        function endCutscene() {
            // Fade out the entire cutscene
            document.getElementById('cutsceneContainer').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('cutsceneContainer').classList.remove('active');
                document.getElementById('cutsceneContainer').style.opacity = '1';
                // Start the actual level
                loadLevel(1);
                game.state = 'playing';
            }, 1000);
        }

        function loadLevel(num) {
            game.levelData = JSON.parse(JSON.stringify(levels[num]));
            game.stonesCollected = 0;

            // Reset player
            player.x = 50;
            player.y = 450;
            player.vx = 0;
            player.vy = 0;
            player.grounded = false;
            player.animFrame = 0;

            // Update UI
            updateUI();

            // Update title
            document.getElementById('gameTitle').textContent = 'THE TIME GUARDIAN: LEVEL ' + num;
            document.getElementById('gameTitle').style.color = '#FFD700';
            document.getElementById('levelSubtitle').textContent = game.levelData.title;
            document.getElementById('levelSubtitle').style.display = 'block';
        }

        function showStoneExercise(stoneId) {
            const exercise = game.levelData.exercises[stoneId];
            if (!exercise) return;

            game.state = 'exercise';
            game.currentStoneExercise = stoneId;

            document.getElementById('stoneExercise').classList.add('active');

            let html = exercise.question.replace(/_____/g,
                '<input type="text" class="text-input" id="stoneAnswer" placeholder="?">');

            document.getElementById('stoneExerciseContent').innerHTML =
                `<div style="margin-bottom: 10px;">${html}</div>
                <div style="color: #666;">Hint: ${exercise.hint}</div>`;
            document.getElementById('stoneExerciseFeedback').innerHTML = '';

            setTimeout(() => {
                const input = document.getElementById('stoneAnswer');
                if (input) input.focus();
            }, 100);
        }

        function checkStoneAnswer() {
            const exercise = game.levelData.exercises[game.currentStoneExercise];
            const input = document.getElementById('stoneAnswer');
            if (!input || !exercise) return;

            const answer = input.value.trim().toLowerCase();
            const correct = exercise.answer.toLowerCase();

            if (answer === correct) {
                game.score += 100;
                document.getElementById('stoneExerciseFeedback').innerHTML =
                    '<div class="feedback success">CORRECT!</div>';

                setTimeout(() => {
                    document.getElementById('stoneExercise').classList.remove('active');
                    game.state = 'playing';
                    updateUI();
                }, 1000);
            } else {
                document.getElementById('stoneExerciseFeedback').innerHTML =
                    '<div class="feedback error">TRY AGAIN!</div>';
            }
        }

        function completeLevel() {
            game.state = 'menu';
            document.getElementById('levelScore').textContent = game.score;
            document.getElementById('levelComplete').classList.add('active');
        }

        function nextLevel() {
            document.getElementById('levelComplete').classList.remove('active');
            if (game.currentLevel < 3) {
                selectLevel(game.currentLevel + 1);
            } else {
                showMainMenu();
            }
        }

        function retryLevel() {
            document.getElementById('gameOver').classList.remove('active');
            loadLevel(game.currentLevel);
            game.lives = 3;
            game.state = 'playing';
        }

        function gameOver() {
            game.state = 'menu';
            document.getElementById('gameOver').classList.add('active');
        }

        function updateUI() {
            document.getElementById('scoreDisplay').textContent = game.score;
            document.getElementById('stoneCount').textContent = game.stonesCollected;

            const livesDisplay = document.getElementById('livesDisplay');
            livesDisplay.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart';
                if (i >= game.lives) heart.classList.add('empty');
                livesDisplay.appendChild(heart);
            }
        }

        // Game physics
        function updatePlayer() {
            if (game.state !== 'playing') return;

            // Controls
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                player.vx = -player.speed;
                player.facing = 'left';
            } else if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                player.vx = player.speed;
                player.facing = 'right';
            } else {
                player.vx *= FRICTION;
            }

            if ((keys[' '] || keys['ArrowUp']) && player.grounded) {
                player.vy = -player.jumpPower;
                player.grounded = false;
            }

            // Gravity
            player.vy += GRAVITY;
            player.x += player.vx;
            player.y += player.vy;

            // Platform collision
            player.grounded = false;
            game.levelData.platforms.forEach(platform => {
                if (player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y < platform.y + platform.height &&
                    player.y + player.height > platform.y) {

                    if (player.vy > 0 && player.y < platform.y) {
                        player.y = platform.y - player.height;
                        player.vy = 0;
                        player.grounded = true;
                    }
                }
            });

            // Time hole collision
            if (game.levelData.timeHoles) {
                game.levelData.timeHoles.forEach(hole => {
                    if (player.x < hole.x + hole.width &&
                        player.x + player.width > hole.x &&
                        player.y < hole.y + hole.height &&
                        player.y + player.height > hole.y) {
                        // Fall into time hole
                        player.y += 5;
                    }
                });
            }

            // Collect stones
            game.levelData.stones.forEach((stone, index) => {
                if (!stone.collected &&
                    Math.abs(player.x + player.width/2 - stone.x) < 20 &&
                    Math.abs(player.y + player.height/2 - stone.y) < 20) {
                    stone.collected = true;
                    game.stonesCollected++;
                    updateUI();
                    showStoneExercise(stone.id);
                }
            });

            // Enemy collision
            game.levelData.enemies.forEach(enemy => {
                if (player.x < enemy.x + enemy.width &&
                    player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height &&
                    player.y + player.height > enemy.y) {

                    player.x = 50;
                    player.y = 450;
                    player.vx = 0;
                    player.vy = 0;
                    game.lives--;
                    updateUI();

                    if (game.lives <= 0) {
                        gameOver();
                    }
                }
            });

            // Portal collision
            const portal = game.levelData.portal;
            if (Math.abs(player.x + player.width/2 - (portal.x + 30)) < 40 &&
                Math.abs(player.y + player.height/2 - (portal.y + 35)) < 40) {

                if (game.stonesCollected >= game.levelData.stones.length) {
                    completeLevel();
                }
            }

            // Fall off screen
            if (player.y > canvas.height) {
                player.x = 50;
                player.y = 450;
                player.vx = 0;
                player.vy = 0;
                game.lives--;
                updateUI();

                if (game.lives <= 0) {
                    gameOver();
                }
            }

            // Update camera
            game.camera.x = Math.max(0, Math.min(player.x - canvas.width/2, 2400 - canvas.width));

            // Animation
            player.animTimer++;
            if (player.animTimer > 10) {
                player.animTimer = 0;
                player.animFrame = (player.animFrame + 1) % 4;
            }
        }

        function updateEnemies() {
            if (!game.levelData) return;

            game.levelData.enemies.forEach(enemy => {
                if (!enemy.startX) enemy.startX = enemy.x;

                enemy.x += enemy.vx;

                if (Math.abs(enemy.x - enemy.startX) > enemy.range) {
                    enemy.vx *= -1;
                }
            });
        }

        // Main render function
        function render() {
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);

            if (game.currentLevel === 1) {
                // Colonial era sky
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(0.3, '#87CEEB');
                gradient.addColorStop(0.7, '#FDB863');
                gradient.addColorStop(1, '#F4A582');
            } else {
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(0.5, '#87CEEB');
                gradient.addColorStop(1, '#98D8E8');
            }

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!game.levelData || game.state === 'menu') return;

            ctx.save();
            ctx.translate(-game.camera.x, -game.camera.y);

            // Draw clouds (32-bit style)
            for (let i = 0; i < 6; i++) {
                const x = (i * 350 + Date.now() / 150) % 2400;
                const y = 30 + i * 25;

                // Cloud shadow
                ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                ctx.beginPath();
                ctx.arc(x + 2, y + 2, 25, 0, Math.PI * 2);
                ctx.arc(x + 27, y + 2, 30, 0, Math.PI * 2);
                ctx.arc(x + 52, y + 2, 25, 0, Math.PI * 2);
                ctx.fill();

                // Cloud
                const cloudGradient = ctx.createRadialGradient(x + 25, y - 10, 0, x + 25, y, 40);
                cloudGradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                cloudGradient.addColorStop(1, 'rgba(255, 255, 255, 0.6)');
                ctx.fillStyle = cloudGradient;
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.arc(x + 25, y, 30, 0, Math.PI * 2);
                ctx.arc(x + 50, y, 25, 0, Math.PI * 2);
                ctx.arc(x + 15, y - 15, 20, 0, Math.PI * 2);
                ctx.arc(x + 35, y - 10, 20, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw background elements
            if (game.levelData.background) {
                // Colonial buildings
                if (game.levelData.background.colonialBuildings) {
                    game.levelData.background.colonialBuildings.forEach(building => {
                        drawColonialBuilding(building.x, building.y);
                    });
                }

                // Liberty Bell
                if (game.levelData.background.libertyBell) {
                    drawLibertyBell(game.levelData.background.libertyBell.x,
                                  game.levelData.background.libertyBell.y);
                }

                // Street lamps
                if (game.levelData.background.streetLamps) {
                    game.levelData.background.streetLamps.forEach(lamp => {
                        drawStreetLamp(lamp.x, lamp.y);
                    });
                }

                // Horses and carriages
                if (game.levelData.background.horses) {
                    game.levelData.background.horses.forEach(horse => {
                        drawHorseCarriage(horse.x, horse.y);
                    });
                }

                // Trees (if any)
                if (game.levelData.background.trees) {
                    game.levelData.background.trees.forEach(tree => {
                        drawTree(tree.x, tree.y);
                    });
                }

                // Windmill (if any)
                if (game.levelData.background.windmill) {
                    drawWindmill(game.levelData.background.windmill.x,
                               game.levelData.background.windmill.y);
                }
            }

            // Draw cobblestone texture on ground platforms
            game.levelData.platforms.forEach(platform => {
                // Only for ground level platforms
                if (platform.y >= 500) {
                    // Cobblestone pattern
                    ctx.fillStyle = '#696969';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);

                    // Stone texture
                    ctx.strokeStyle = '#545454';
                    ctx.lineWidth = 1;
                    for (let sy = platform.y; sy < platform.y + platform.height; sy += 15) {
                        for (let sx = platform.x; sx < platform.x + platform.width; sx += 20) {
                            ctx.strokeRect(sx + (sy % 2) * 10, sy, 20, 15);
                        }
                    }

                    // Worn effect
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                    for (let i = 0; i < 20; i++) {
                        const wx = platform.x + Math.random() * platform.width;
                        const wy = platform.y + Math.random() * platform.height;
                        ctx.beginPath();
                        ctx.arc(wx, wy, Math.random() * 5 + 2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else {
                    // Floating platforms
                    const platGradient = ctx.createLinearGradient(platform.x, platform.y, platform.x, platform.y + platform.height);
                    platGradient.addColorStop(0, '#8B7355');
                    platGradient.addColorStop(0.3, '#A0826D');
                    platGradient.addColorStop(1, '#6B5637');
                    ctx.fillStyle = platGradient;
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);

                    // Wood grain
                    ctx.strokeStyle = '#5A4A3A';
                    ctx.lineWidth = 0.5;
                    for (let i = 0; i < platform.width; i += 8) {
                        ctx.beginPath();
                        ctx.moveTo(platform.x + i, platform.y);
                        ctx.lineTo(platform.x + i + 3, platform.y + platform.height);
                        ctx.stroke();
                    }
                }
            });

            // Draw time holes (black voids with glitch effect)
            if (game.levelData.timeHoles) {
                game.levelData.timeHoles.forEach(hole => {
                    // Black void with gradient
                    const holeGradient = ctx.createRadialGradient(
                        hole.x + hole.width/2, hole.y + hole.height/2, 0,
                        hole.x + hole.width/2, hole.y + hole.height/2, hole.width/2
                    );
                    holeGradient.addColorStop(0, '#000');
                    holeGradient.addColorStop(0.7, '#000');
                    holeGradient.addColorStop(1, 'rgba(0, 0, 0, 0.8)');
                    ctx.fillStyle = holeGradient;
                    ctx.fillRect(hole.x, hole.y, hole.width, hole.height);

                    // Glitch effect border
                    const time = Date.now() / 200;
                    for (let i = 0; i < 3; i++) {
                        ctx.strokeStyle = `hsl(${(time + i * 120) % 360}, 100%, 50%)`;
                        ctx.lineWidth = 2;
                        ctx.globalAlpha = 0.7 - i * 0.2;
                        ctx.strokeRect(hole.x - 2 - i*2, hole.y - 2 - i*2,
                                     hole.width + 4 + i*4, hole.height + 4 + i*4);
                    }
                    ctx.globalAlpha = 1;

                    // Warning particles
                    for (let i = 0; i < 5; i++) {
                        const px = hole.x + hole.width/2 + Math.sin(time/2 + i * 2) * 40;
                        const py = hole.y - 10 - Math.abs(Math.sin(time/3 + i)) * 30;

                        const particleGradient = ctx.createRadialGradient(px, py, 0, px, py, 5);
                        particleGradient.addColorStop(0, '#ff0066');
                        particleGradient.addColorStop(1, 'rgba(255, 0, 102, 0)');
                        ctx.fillStyle = particleGradient;
                        ctx.fillRect(px - 5, py - 5, 10, 10);
                    }
                });
            }

            // Draw collectibles
            game.levelData.stones.forEach(stone => {
                if (!stone.collected) {
                    drawStone(stone.x, stone.y);
                }
            });

            // Draw enemies
            game.levelData.enemies.forEach(enemy => {
                drawEnemy(enemy.x, enemy.y);
            });

            // Draw portal
            const portal = game.levelData.portal;
            const unlocked = game.stonesCollected >= game.levelData.stones.length;
            drawPortal(portal.x, portal.y, unlocked);

            // Draw player
            drawLila(player.x, player.y, player.facing);

            ctx.restore();
        }

        // Draw tree (32-bit style)
        function drawTree(x, y) {
            // Tree shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.ellipse(x, y + 5, 30, 10, 0, 0, Math.PI * 2);
            ctx.fill();

            // Trunk with gradient
            const trunkGradient = ctx.createLinearGradient(x - 8, y - 20, x + 8, y - 20);
            trunkGradient.addColorStop(0, '#654321');
            trunkGradient.addColorStop(0.5, '#8B4513');
            trunkGradient.addColorStop(1, '#654321');
            ctx.fillStyle = trunkGradient;
            ctx.fillRect(x - 8, y - 20, 16, 20);

            // Trunk texture
            ctx.strokeStyle = '#4A3018';
            ctx.lineWidth = 1;
            for (let ty = y - 18; ty < y; ty += 4) {
                ctx.beginPath();
                ctx.moveTo(x - 6, ty);
                ctx.lineTo(x - 4, ty + 2);
                ctx.stroke();
            }

            // Leaves with gradient
            const leavesGradient = ctx.createRadialGradient(x, y - 50, 0, x, y - 50, 40);
            leavesGradient.addColorStop(0, '#32CD32');
            leavesGradient.addColorStop(0.5, '#228B22');
            leavesGradient.addColorStop(1, '#006400');
            ctx.fillStyle = leavesGradient;

            // Leaf clusters
            ctx.beginPath();
            ctx.arc(x - 20, y - 45, 20, 0, Math.PI * 2);
            ctx.arc(x + 20, y - 45, 20, 0, Math.PI * 2);
            ctx.arc(x, y - 60, 25, 0, Math.PI * 2);
            ctx.arc(x - 15, y - 65, 18, 0, Math.PI * 2);
            ctx.arc(x + 15, y - 65, 18, 0, Math.PI * 2);
            ctx.fill();

            // Highlight spots
            ctx.fillStyle = 'rgba(50, 205, 50, 0.3)';
            ctx.beginPath();
            ctx.arc(x - 10, y - 55, 8, 0, Math.PI * 2);
            ctx.arc(x + 12, y - 48, 10, 0, Math.PI * 2);
            ctx.fill();
        }

        // Draw windmill (32-bit style)
        function drawWindmill(x, y) {
            // Base shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(x - 28, y + 75, 56, 10);

            // Base with gradient
            const baseGradient = ctx.createLinearGradient(x - 20, y, x + 20, y);
            baseGradient.addColorStop(0, '#BC8F5F');
            baseGradient.addColorStop(0.5, '#D2691E');
            baseGradient.addColorStop(1, '#BC8F5F');
            ctx.fillStyle = baseGradient;
            ctx.fillRect(x - 20, y, 40, 60);
            ctx.fillRect(x - 24, y + 60, 48, 20);

            // Stone texture
            ctx.strokeStyle = '#A0522D';
            ctx.lineWidth = 0.5;
            for (let sy = y; sy < y + 80; sy += 10) {
                for (let sx = x - 24; sx < x + 24; sx += 12) {
                    ctx.strokeRect(sx, sy, 12, 10);
                }
            }

            // Roof with gradient
            const roofGradient = ctx.createLinearGradient(x, y - 30, x, y);
            roofGradient.addColorStop(0, '#8B4513');
            roofGradient.addColorStop(0.5, '#A0522D');
            roofGradient.addColorStop(1, '#654321');
            ctx.fillStyle = roofGradient;
            ctx.beginPath();
            ctx.moveTo(x - 30, y);
            ctx.lineTo(x, y - 30);
            ctx.lineTo(x + 30, y);
            ctx.closePath();
            ctx.fill();

            // Door
            const doorGradient = ctx.createLinearGradient(x - 8, y + 40, x + 8, y + 40);
            doorGradient.addColorStop(0, '#654321');
            doorGradient.addColorStop(0.5, '#8B4513');
            doorGradient.addColorStop(1, '#654321');
            ctx.fillStyle = doorGradient;
            ctx.fillRect(x - 8, y + 40, 16, 20);

            // Blades
            ctx.save();
            ctx.translate(x, y - 10);
            ctx.rotate(Date.now() / 3000);

            for (let i = 0; i < 4; i++) {
                ctx.rotate(Math.PI / 2);

                // Blade arm
                const bladeGradient = ctx.createLinearGradient(0, 0, 0, 30);
                bladeGradient.addColorStop(0, '#8B4513');
                bladeGradient.addColorStop(1, '#654321');
                ctx.fillStyle = bladeGradient;
                ctx.fillRect(-2, 0, 4, 30);

                // Blade fabric
                ctx.fillStyle = '#D2B48C';
                ctx.beginPath();
                ctx.moveTo(0, 20);
                ctx.lineTo(-8, 25);
                ctx.lineTo(-6, 35);
                ctx.lineTo(6, 35);
                ctx.lineTo(8, 25);
                ctx.closePath();
                ctx.fill();

                // Fabric lines
                ctx.strokeStyle = '#A0826D';
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                ctx.moveTo(0, 25);
                ctx.lineTo(0, 35);
                ctx.stroke();
            }

            ctx.restore();

            // Center hub
            ctx.fillStyle = '#654321';
            ctx.beginPath();
            ctx.arc(x, y - 10, 4, 0, Math.PI * 2);
            ctx.fill();
        }

        // Game loop
        function gameLoop() {
            updatePlayer();
            updateEnemies();
            render();
            requestAnimationFrame(gameLoop);
        }

        // Hide loading screen and start
        setTimeout(() => {
            document.getElementById('loadingScreen').style.display = 'none';
        }, 500);

        // Start game loop
        gameLoop();
    </script>
</body>
</html>